import sys
import asyncio
import re

from src.fly.core.drone import Drone
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QPushButton, QLabel, QHBoxLayout,
    QVBoxLayout, QWidget, QTextEdit, QLineEdit, QGridLayout, QDoubleSpinBox, QTabWidget
)
from qasync import asyncSlot, QEventLoop

def is_valid_port(port: str) -> bool:
    udp_pattern = r"^udp(?:in|out)?://([0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]{1,5}$"
    tcp_pattern = r"^tcp(?:in|out)?://([0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]{1,5}$"
    serial_pattern = r"^serial://(/dev/[a-zA-Z0-9_-]+|COM[0-9]+)(:[0-9]+)?$"

    if re.match(udp_pattern, port):
        return True
    if re.match(tcp_pattern, port):
        return True
    if re.match(serial_pattern, port):
        return True
    return False


class TC_Drone_App(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Drone Controls")
        self.setGeometry(100, 100, 400, 400)

        self.drone = None
    
        central = QWidget()
        layout = QVBoxLayout()

        # Create tab widget
        self.tabs = QTabWidget()
        
        # Tab 1: Basic Controls (your existing)
        basic_layout = QVBoxLayout()
        
        self.port_edit = QLineEdit()
        self.port_edit.setPlaceholderText("Port, e.g. udpin://0.0.0.0:14540")

        self.button_connect = QPushButton("1. Connect to the drone")
        self.button_connect.setCheckable(True)
        self.button_connect.clicked.connect(self.on_connect)


        self.button_takeoff = QPushButton("2. Takeoff (10m)")
        self.button_takeoff.setEnabled(False)
        self.button_takeoff.clicked.connect(self.on_takeoff)

        self.button_land = QPushButton("3. Land The Drone")
        self.button_land.setCheckable(True)  # Enable toggle
        self.button_land.setEnabled(False)   # Disable initially
        self.button_land.clicked.connect(self.on_land)
        self.button_land.setStyleSheet("""
    QPushButton:disabled {
        background-color: lightcoral;
        color: white;
    }
    QPushButton:!checked {
        background-color: red;
        color: white;
    }
    QPushButton:checked {
        background-color: orange;
        color: white;
    }
    QPushButton:pressed {
        background-color: darkorange;
        color: white;
    }
""")
        
        self.status = QLabel("Status: Disconnected")
        basic_layout.addWidget(self.status)
        self.console = QTextEdit()
        self.console.setReadOnly(True)
        basic_layout.addWidget(self.console)

        
        self.status = QLabel("Status: Disconnected")
        self.console = QTextEdit()
        self.console.setReadOnly(True)
        
        layout.addWidget(self.port_edit)
        layout.addWidget(self.button_connect)
        layout.addWidget(self.button_takeoff)
        layout.addWidget(self.button_land)
        layout.addWidget(self.status)
        layout.addWidget(self.console)
        central.setLayout(layout)
        self.setCentralWidget(central)

    def log(self, msg):
        self.console.append(msg)
        print(msg)

    @asyncSlot()
    async def on_connect(self):
        if self.button_connect.isChecked():
            port = self.port_edit.text().strip()
            if not port:
                port = "udpin://0.0.0.0:14540"
                self.log("-- Port not specified, defaulting to udpin://0.0.0.0:14540")

            # Validate port string
            if not is_valid_port(port):
                self.log("-- Invalid port format. Please specify a valid UDP, TCP, or Serial port.")
                self.status.setText("Status: Invalid port")
                self.button_connect.setChecked(False)
                return
            
            self.drone = Drone(port=port)

            self.log("Connecting...")
            try:
                connected = await self.drone.connect()
                if connected:
                    self.status.setText("Status: Connected")
                    self.log("Connected...")
                    self.button_takeoff.setEnabled(True) # Enable Takeoff
                    
                    # Optional: Get position confirmation
                    lat, lon, alt = await self.drone.current_position()
                    self.log(f"Pos: {lat:.5f}, {lon:.5f}, {alt:.1f}m")
                else:
                    self.status.setText("Status: Connection Failed")
                    self.log("-- Connection test failed; consider trying a different port.")
                    self.button_connect.setChecked(False)
            except Exception as e:
                self.log(f"Error: {e}")
                self.button_connect.setEnabled(False)
        else:
            self.status.setText("Status: Disconnected")
            self.button_takeoff.setEnabled(False)

    @asyncSlot()
    async def on_takeoff(self):
        if not self.drone:
            self.log("No drone instance; connect first.")
            return
        self.log("Starting Takeoff Sequence...")
        self.button_takeoff.setEnabled(False)
        try:
            await self.drone.takeoff(10.0) 
            self.log("Takeoff...")
            self.status.setText("Status: Taken off")
            self.button_land.setEnabled(True)
        except Exception as e:
            self.log(f"Takeoff Error: {e}")
            self.button_takeoff.setEnabled(True)

    @asyncSlot()
    async def on_land(self):
        self.log("Starting Landing Sequence...")
        try:
            await self.drone.land() 
            self.log("Landing...")
            self.status.setText("Status: Landing")
            self.button_land.setChecked(False)  # Reset toggle
            self.button_land.setEnabled(False)  # Disable again
            self.button_takeoff.setEnabled(True)

        except Exception as e:
            self.log(f"Landing Error Error: {e}")
            self.button_takeoff.setEnabled(True)





if __name__ == "__main__":
    app = QApplication(sys.argv)
    loop = QEventLoop(app)
    asyncio.set_event_loop(loop)
    
    win = TC_Drone_App()
    win.show()
    
    with loop:
        loop.run_forever()